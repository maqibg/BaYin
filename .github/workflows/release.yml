name: Release Tauri App (Windows + Android)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 第一步：创建草稿 Release
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      tag_name: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Get Tag Name
        id: get-tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Draft Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = "${{ steps.get-tag.outputs.tag }}";
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `BaYin ${tagName}`,
              draft: true,
              prerelease: false
            });
            core.setOutput('id', data.id);

  # 第二步：构建 Windows 版本
  build-windows:
    needs: create-release
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: aarch64-pc-windows-msvc
            arch: arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install Frontend Dependencies
        run: npm install
        working-directory: ./src-ui

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Build & Upload Windows App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target ${{ matrix.target }}
          tauriScript: npx tauri

  # 第三步：构建 Android 版本
  build-android:
    needs: create-release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [aarch64, armv7, x86_64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup NDK
        run: |
          sdkmanager --install "ndk;26.3.11579264"
          echo "NDK_HOME=$ANDROID_HOME/ndk/26.3.11579264" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install Frontend Dependencies
        run: npm install
        working-directory: ./src-ui

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Initialize Android Project
        run: npx tauri android init

      - name: Decode Android Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > $GITHUB_WORKSPACE/release.keystore

      - name: Generate keystore.properties
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          mkdir -p src-tauri/gen/android
          cat > src-tauri/gen/android/keystore.properties << EOF
          storeFile=$GITHUB_WORKSPACE/release.keystore
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_PASSWORD
          EOF

      - name: Configure Gradle Signing
        run: |
          GRADLE_FILE="src-tauri/gen/android/app/build.gradle.kts"

          # 添加 import（如果不存在）
          if ! grep -q "import java.io.FileInputStream" "$GRADLE_FILE"; then
            sed -i '1i import java.io.FileInputStream' "$GRADLE_FILE"
          fi
          if ! grep -q "import java.util.Properties" "$GRADLE_FILE"; then
            sed -i '1i import java.util.Properties' "$GRADLE_FILE"
          fi

          # 添加签名配置（如果不存在）
          if ! grep -q "keystorePropsFile" "$GRADLE_FILE"; then
            cat >> "$GRADLE_FILE" << 'EOF'

          // Auto-generated signing config
          val keystorePropsFile = rootProject.file("keystore.properties")
          if (keystorePropsFile.exists()) {
              val keystoreProps = Properties().apply {
                  load(FileInputStream(keystorePropsFile))
              }
              android.signingConfigs.getByName("release") {
                  storeFile = file(keystoreProps["storeFile"] as String)
                  storePassword = keystoreProps["storePassword"] as String
                  keyAlias = keystoreProps["keyAlias"] as String
                  keyPassword = keystoreProps["keyPassword"] as String
              }
          }
          EOF
          fi

      - name: Build Android APK
        run: npx tauri android build --target ${{ matrix.target }}

      - name: Upload APK to Release
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
          TAG_NAME: ${{ needs.create-release.outputs.tag_name }}
          TARGET_ARCH: ${{ matrix.target }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const tagName = process.env.TAG_NAME;
            const arch = process.env.TARGET_ARCH;
            const releaseId = parseInt(process.env.RELEASE_ID, 10);

            const apkPaths = [
              `src-tauri/gen/android/app/build/outputs/apk/${arch}/release`,
              'src-tauri/gen/android/app/build/outputs/apk/universal/release',
              'src-tauri/gen/android/app/build/outputs/apk/release'
            ];

            let uploaded = false;
            for (const dir of apkPaths) {
              if (!fs.existsSync(dir)) continue;
              const apks = fs.readdirSync(dir).filter(f => f.endsWith('.apk') && !f.includes('unsigned'));
              for (const apk of apks) {
                const apkPath = path.join(dir, apk);
                const newName = `BaYin-${tagName}-android-${arch}.apk`;
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: newName,
                  data: fs.readFileSync(apkPath)
                });
                console.log(`Uploaded: ${newName}`);
                uploaded = true;
              }
            }
            if (!uploaded) throw new Error(`No signed APK found for arch: ${arch}`);

      - name: Cleanup Keystore
        if: always()
        run: rm -f $GITHUB_WORKSPACE/release.keystore src-tauri/gen/android/keystore.properties

  # 第四步：发布 Release
  publish-release:
    needs: [create-release, build-windows, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID, 10),
              draft: false
            });
            console.log('Release published!');
