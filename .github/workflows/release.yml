name: Release Tauri App

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 第一步：创建草稿发布
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      tag_name: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get tag name
        id: get-tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Draft Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `BaYin ${tagName}`,
              draft: true,
              prerelease: false
            });
            core.setOutput('id', data.id);

  # 第二步：构建 Windows 版本
  build-windows:
    needs: create-release
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
          - target: aarch64-pc-windows-msvc
            arch: arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install Frontend Dependencies
        run: npm install
        working-directory: ./src-ui

      - name: Build and Upload
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: --target ${{ matrix.target }}

  # 第三步：构建 Android 版本（带签名）
  build-android:
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup NDK
        run: |
          sdkmanager --install "ndk;27.0.12077973"
          echo "NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install Frontend Dependencies
        run: npm install
        working-directory: ./src-ui

      # 配置 Android 签名
      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > ${{ github.workspace }}/release.keystore

      - name: Create keystore.properties
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          cat > src-tauri/gen/android/keystore.properties << EOF
          storeFile=${{ github.workspace }}/release.keystore
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          keyPassword=$ANDROID_KEY_PASSWORD
          EOF

      # 初始化 Android 项目（生成 gen/android 目录）
      - name: Initialize Android Project
        run: npm run tauri android init

      # 配置 Gradle 签名
      - name: Configure Gradle Signing
        run: |
          # 在 app/build.gradle.kts 中添加签名配置
          cat >> src-tauri/gen/android/app/build.gradle.kts << 'EOF'

          // Release signing config
          val keystorePropertiesFile = rootProject.file("keystore.properties")
          if (keystorePropertiesFile.exists()) {
              val keystoreProperties = java.util.Properties()
              keystoreProperties.load(java.io.FileInputStream(keystorePropertiesFile))

              android.signingConfigs {
                  create("release") {
                      storeFile = file(keystoreProperties["storeFile"] as String)
                      storePassword = keystoreProperties["storePassword"] as String
                      keyAlias = keystoreProperties["keyAlias"] as String
                      keyPassword = keystoreProperties["keyPassword"] as String
                  }
              }

              android.buildTypes.getByName("release") {
                  signingConfig = android.signingConfigs.getByName("release")
              }
          }
          EOF

      - name: Build Android APK (arm64)
        run: npm run tauri android build -- --target aarch64

      - name: Build Android APK (arm32)
        run: npm run tauri android build -- --target armv7

      - name: Build Android APK (x86_64)
        run: npm run tauri android build -- --target x86_64

      - name: Rename and Upload APKs
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
          TAG_NAME: ${{ needs.create-release.outputs.tag_name }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const tagName = process.env.TAG_NAME;

            // 查找所有 APK 文件
            const searchDirs = [
              'src-tauri/gen/android/app/build/outputs/apk/universal/release',
              'src-tauri/gen/android/app/build/outputs/apk/release'
            ];

            const archNames = {
              'arm64-v8a': 'arm64',
              'armeabi-v7a': 'arm32',
              'x86_64': 'x86_64',
              'x86': 'x86',
              'universal': 'universal'
            };

            for (const dir of searchDirs) {
              if (!fs.existsSync(dir)) continue;

              const files = fs.readdirSync(dir).filter(f => f.endsWith('.apk') && !f.includes('unsigned'));

              for (const file of files) {
                const filePath = path.join(dir, file);
                const fileContent = fs.readFileSync(filePath);

                // 从文件名提取架构信息
                let arch = 'universal';
                for (const [key, value] of Object.entries(archNames)) {
                  if (file.includes(key)) {
                    arch = value;
                    break;
                  }
                }

                const newName = `BaYin-${tagName}-android-${arch}.apk`;

                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: parseInt(process.env.RELEASE_ID, 10),
                  name: newName,
                  data: fileContent
                });

                console.log(`Uploaded: ${file} -> ${newName}`);
              }
            }

      - name: Cleanup Keystore
        if: always()
        run: rm -f ${{ github.workspace }}/release.keystore

  # 第四步：发布
  publish-release:
    needs: [create-release, build-windows, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ needs.create-release.outputs.release_id }}
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: parseInt(process.env.RELEASE_ID, 10),
              draft: false
            });
